#!/bin/zsh

PLUG_DIR="${HOME}/.config/nnn/plugins"
OUT_FILE="${HOME}/.config/nnn/nnn-plug.zsh"
USED_KEYS=()

echo "🔍 Scanning $PLUG_DIR for plugins..."

plug_list=()

for plugin_path in "$PLUG_DIR"/*(.x); do
  plugin="${plugin_path##*/}"

  # 추출: 첫 주석 → 설명
  desc="$(grep -m1 '^#' "$plugin_path" | sed 's/^# *//')"
  [[ -z "$desc" ]] && desc="no description"

  # 자동 단축키 할당
  key_candidate="${plugin[1]}"  # 첫 글자
  key="${key_candidate}"

  # 충돌 방지: 중복 키 피하기
  i=2
  while [[ " ${USED_KEYS[@]} " == *" $key "* ]]; do
    key="${plugin[i]}"
    (( i++ ))
    [[ $i -gt ${#plugin} ]] && key="_" && break
  done

  USED_KEYS+=("$key")
  plug_list+=("${key}:${plugin} (${desc})")
done

# Join with ;
plug_string="${(j/;/)plug_list}"

# Write to file
cat <<EOF > "$OUT_FILE"
# Auto-generated by generate-nnn-plug.zsh
# Last updated: $(date)
export NNN_PLUG='${plug_string}'
EOF

echo "✅ Done!"
echo "📁 Saved to: $OUT_FILE"
echo "➕ Add this to your .zshrc if not already:"
echo "    source $OUT_FILE"