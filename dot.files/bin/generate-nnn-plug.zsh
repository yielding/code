#!/bin/zsh

PLUG_DIR="${HOME}/.config/nnn/plugins"
OUT_FILE="${HOME}/.config/nnn/nnn-plug.zsh"
USED_KEYS=()

echo "ğŸ” Scanning $PLUG_DIR for plugins..."

plug_list=()

for plugin_path in "$PLUG_DIR"/*(.x); do
  plugin="${plugin_path##*/}"

  # ì¶”ì¶œ: ì²« ì£¼ì„ â†’ ì„¤ëª…
  desc="$(grep -m1 '^#' "$plugin_path" | sed 's/^# *//')"
  [[ -z "$desc" ]] && desc="no description"

  # ìë™ ë‹¨ì¶•í‚¤ í• ë‹¹
  key_candidate="${plugin[1]}"  # ì²« ê¸€ì
  key="${key_candidate}"

  # ì¶©ëŒ ë°©ì§€: ì¤‘ë³µ í‚¤ í”¼í•˜ê¸°
  i=2
  while [[ " ${USED_KEYS[@]} " == *" $key "* ]]; do
    key="${plugin[i]}"
    (( i++ ))
    [[ $i -gt ${#plugin} ]] && key="_" && break
  done

  USED_KEYS+=("$key")
  plug_list+=("${key}:${plugin} (${desc})")
done

# Join with ;
plug_string="${(j/;/)plug_list}"

# Write to file
cat <<EOF > "$OUT_FILE"
# Auto-generated by generate-nnn-plug.zsh
# Last updated: $(date)
export NNN_PLUG='${plug_string}'
EOF

echo "âœ… Done!"
echo "ğŸ“ Saved to: $OUT_FILE"
echo "â• Add this to your .zshrc if not already:"
echo "    source $OUT_FILE"